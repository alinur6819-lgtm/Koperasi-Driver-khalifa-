<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bayar Angsuran</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
header{background:#1e90ff;color:#fff;padding:12px;display:flex;justify-content:space-between}
.container{padding:15px}
.card{background:#fff;padding:12px;border-radius:10px;margin-bottom:10px}
input,select{width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ccc}
button{padding:10px;border:none;border-radius:8px;background:#1e90ff;color:white;font-weight:bold}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:center}
</style>
</head>

<body>

<header>
<h3>ðŸ’µ Bayar Angsuran</h3>
<button onclick="location.href='dashboard.html'">Dashboard</button>
</header>

<div class="container">

<div class="card">
<select id="pinjaman"></select>

<label>Sisa Pinjaman</label>
<input id="sisa" readonly>

<label>Jumlah Bayar</label>
<input type="number" id="bayar">

<button onclick="bayarAngsuran()">Bayar</button>
</div>

<table>
<thead>
<tr>
<tr>
 <th>Nama</th>
 <th>Tanggal</th>
 <th>Tenor</th>
  <th>Jumlah Bayar</th>
 <th>Sisa</th>
 <th>Status</th>
 
</tr>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

</div>

<script src="js/storage.js"></script>

<script>
function rupiah(n){
 return "Rp "+Number(n||0).toLocaleString("id-ID");
}

function loadPinjaman(){

 const db = getDB();
 pinjaman.innerHTML="";

 db.pinjaman.forEach((p,i)=>{
  if(p.sisa>0){
   pinjaman.innerHTML+=`
    <option value="${i}">
     ${p.nama} - ${rupiah(p.sisa)}
    </option>`;
  }
 });

 updateSisa();
}

function updateSisa(){
 const db=getDB();
 const p=db.pinjaman[pinjaman.value];
 if(p) sisa.value=rupiah(p.sisa);
}

pinjaman.addEventListener("change",updateSisa);

function bayarAngsuran(){

 const db=getDB();
 const idx=pinjaman.value;
 const p=db.pinjaman[idx];
 const j=Number(bayar.value);

 if(!p||j<=0){
  alert("Lengkapi");
  return;
 }

 if(j>p.sisa){
  alert("Melebihi sisa pinjaman");
  return;
 }

 const t=new Date().toISOString().slice(0,10);

 p.sisa-=j;

 db.kas.push({
  id:Date.now(),
  tanggal:t,
  keterangan:"Angsuran "+p.nama,
  jenis:"MASUK",
  jumlah:j
 });

 saveDB(db);

 bayar.value="";
 loadPinjaman();
 loadRiwayat();

 alert("Angsuran tersimpan");
}
function loadRiwayat(){

 const db = getDB();
 list.innerHTML = "";

 db.kas
  .filter(k=>k.keterangan.includes("Angsuran"))
  .forEach(k=>{

   const nama = k.keterangan.replace("Angsuran ","");

   // cari pinjaman anggota
   const p = db.pinjaman.find(x=>x.nama===nama);

   const tenor = p?.tenor || "-";
   const sisa = p?.sisa ?? 0;

   const status = sisa==0
     ? "<span style='color:green;font-weight:bold'>LUNAS</span>"
     : "<span style='color:red;font-weight:bold'>BELUM</span>";

   list.innerHTML += `
    <tr>
     <td>${nama}</td>
     <td>${k.tanggal}</td>
     <td>${tenor} bln</td>
    <td>${rupiah(k.jumlah)}</td>
     <td>${rupiah(sisa)}</td>
     <td>${status}</td>
     
    </tr>`;
  });
}


document.addEventListener("DOMContentLoaded",()=>{
 loadPinjaman();
 loadRiwayat();
});
</script>

</body>
</html>